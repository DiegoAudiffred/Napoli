<style>
    #contenidoImprimir {
        width: 5.8cm;
        height: 20cm;
        /* Ancho del ticket */
        font-family: Arial, sans-serif;
        /* Fuente del texto */
        font-size: 12px;
        /* Tamaño de la fuente */
        margin: 0 auto;
        /* Centrar el contenido horizontalmente */
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th,
    .table td {
        border: 1px solid black;
        /* Borde de las celdas */
        padding: 4px;
        /* Espaciado interno de las celdas */
        text-align: left;
        /* Alinear el texto a la izquierda */
    }

    .table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
        /* Fondo de las filas pares */
    }

    hr {
        border: none;
        /* Eliminar el borde del hr */
        border-top: 1px solid black;
        /* Establecer un borde superior */
        margin: 5px 0;
        /* Espaciado alrededor del hr */
    }

    .container {
        text-align: left;
    }
</style>
<div id="contenidoImprimir" class="d-block">

    <div class="">
        <div class="row">
            <div class="col-12 text-break">
                Napoli Ristorante y Pizzeria
                C. 29 Sur 119, La Paz, 72160
                Heroica Puebla de Zaragoza
                Teléfono: 222 621 9650 

            </div>
            <div class="col-12 text-break">
                ------------------------------------

            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-12">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Total</th>

                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>{{ item.menu.nombre|truncatechars:15 }}</td>
                            <td>{{ item.cantidad }} U</td>
                            <td>${{ item.totalfinal }}</td>

                        </tr>


                        {% if item.extras.exists %}
                        <tr>
                            <td colspan="3">
                                <ul>
                                    {% for extra in item.extras.all %}
                                    <li>{{ extra.nombre|truncatechars:20 }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                        {% endif %}

                        {% endfor %}

                        <tr>
                            <td>
                                <strong>Total final:</strong>

                            </td>
                            <td>

                            </td>
                            <td><strong>${{venta.total}}</strong></td>
                        </tr>


                    </tbody>
                </table>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-12 text-break">
                Fecha: {{ venta.fecha_compra|date:"d-m-Y H:i" }}:0{{venta.numVentaDia}}
                <hr>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-12 text-break">
                Mesa : {{venta.mesa}}
                <hr>
            </div>
        </div>
         {% if venta.direccion  %}
            <div class="row justify-content-center">
            <div class="col-12 text-break">
                Direccion: {{venta.direccion}}
                <hr>
            </div>
        </div>
         {% endif %}
        <div class="row justify-content-center">
            <div class="col-12 text-break">
                Este ticket no es un comprobante fiscal. Para facturar mandar sus datos fiscales completos al correo:
                napoli10.facturacion@gmail.com
                <hr>
            </div>
        </div>

    </div>
</div>
<!-- <button onclick="imprimirContenido2()" class="btn btn-quinto w-100 text-white">Imprimir ticket 2</button>
 -->
<script>
    var conteoImpresiones = 0; // Variable para contar las impresiones

    function imprimirContenido2() {
        // Obtener el contenido a imprimir
        var contenidoImprimir = document.getElementById('contenidoImprimir').innerHTML;

        // Abrir una ventana de impresión
        var ventanaImpresion = window.open('', '_blank', 'width=600,height=600');
        
        // Escribir el contenido en la ventana de impresión
        ventanaImpresion.document.write('<html><head><title>Imprimir contenido</title></head><body>');
        ventanaImpresion.document.write(contenidoImprimir);
        ventanaImpresion.document.write('</body></html>');
        ventanaImpresion.document.close();
        
        // Incrementar el conteo de impresiones cuando la ventana de impresión se carga completamente
        ventanaImpresion.addEventListener('load', function() {
            conteoImpresiones++;
            console.log('Impresión exitosa');
        });
        
        // Imprimir el contenido y cerrar la ventana de impresión
        ventanaImpresion.print();
        ventanaImpresion.close();


    // Obtener el token CSRF del cookie
    var csrftoken = getCookie('csrftoken');

    // Función para imprimir el contenido y enviar la solicitud AJAX
        // Tu código existente...
        
        // Llamada AJAX para enviar datos al servidor después de imprimir
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'Ventas:actualizar_ticket' venta.id %}", true); 
        xhr.setRequestHeader("X-CSRFToken", csrftoken); // Incluir el token CSRF en la solicitud
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log("Ticket actualizado correctamente en el servidor");
            }
        };
        xhr.send(JSON.stringify({ numImpresion: conteoImpresiones }));
    }

    // Función para obtener el valor del token CSRF del cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Buscar el token CSRF en el cookie
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

